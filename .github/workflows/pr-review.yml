name: Gemini CLI - Revisión de PR

on:
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Número del PR a revisar"
        required: false
        type: string

jobs:
  review:
    name: Revisar PR con Gemini
    runs-on: ubuntu-latest

    # Solo ejecutar en PRs o cuando se solicite específicamente
    if: >-
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review_comment' && 
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/revisar')) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/revisar'))

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Ejecutar Gemini CLI para Revisión
        id: gemini-review
        uses: google-github-actions/run-gemini-cli@v0.1.10
        with:
          prompt: |
            Eres un revisor de código experto y experimentado.

            **PULL REQUEST A REVISAR:**
            Título: ${{ github.event.pull_request.title || 'PR desde comentario' }}
            Descripción: ${{ github.event.pull_request.body || 'Ver comentarios para contexto' }}
            
            Tu tarea es realizar una revisión exhaustiva del Pull Request, enfocándote en:

            🔒 **Seguridad**: Vulnerabilidades, validación de entrada, autenticación
            ⚡ **Rendimiento**: Algoritmos eficientes, consultas optimizadas, uso de memoria
            🛡️ **Confiabilidad**: Manejo de errores, casos edge, testing
            🧹 **Mantenibilidad**: Código limpio, documentación, convenciones
            ✅ **Funcionalidad**: Lógica correcta, cumplimiento de requisitos

            Proporciona feedback específico usando estos emojis de prioridad:
            🔴 **Crítico**: Debe corregirse antes del merge
            🟠 **Alto**: Debería corregirse
            🟡 **Medio**: Mejoras recomendadas
            🟢 **Bajo**: Sugerencias opcionales

            **Formato de respuesta**:

            ## 🔍 Revisión de Código

            ### ✅ Aspectos Positivos
            - [Destacar buenas prácticas encontradas]

            ### 🔍 Análisis por Categoría

            #### 🔒 Seguridad
            [Evaluación de seguridad]

            #### ⚡ Rendimiento  
            [Evaluación de rendimiento]

            #### 🛡️ Confiabilidad
            [Evaluación de confiabilidad]

            #### 🧹 Mantenibilidad
            [Evaluación de mantenibilidad]

            ### 📋 Recomendaciones

            #### 🔴 Críticas
            - [Issues que deben corregirse]

            #### 🟠 Importantes
            - [Mejoras recomendadas]

            #### 🟡 Sugerencias
            - [Mejoras opcionales]

            ### 🎯 Veredicto
            - [ ] ✅ Aprobado - Listo para merge
            - [ ] 🔄 Necesita cambios menores
            - [ ] ⛔ Requiere cambios importantes

            Responde en español, sé constructivo y proporciona ejemplos de código cuando sea útil.

          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Comentar revisión en el PR
        if: success()
        uses: actions/github-script@v7
        env:
          GEMINI_RESPONSE: ${{ steps.gemini-review.outputs.summary }}
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number ||
                           (context.payload.issue?.pull_request ? context.payload.issue.number : null);

            if (prNumber) {
              const geminiResponse = process.env.GEMINI_RESPONSE || 'No se pudo obtener la respuesta de Gemini.';
              
              // Comentar la revisión
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `🤖 **Revisión Automática por Gemini CLI**\n\n${geminiResponse}`
              });
              
              console.log(`Revisión comentada en PR #${prNumber}`);
            }

      - name: Comentar si hay error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number ||
                           (context.payload.issue?.pull_request ? context.payload.issue.number : null);
                           
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '❌ Error al revisar el PR. [Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
              });
            }
