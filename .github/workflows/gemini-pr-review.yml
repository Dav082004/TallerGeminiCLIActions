name: ğŸ§ Gemini CLI - PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "NÃºmero del PR a revisar"
        required: false
        type: string

jobs:
  review:
    name: Revisar PR con Gemini
    runs-on: ubuntu-latest

  # Solo ejecutar: 1) PRs automÃ¡ticamente, 2) manualmente con /review en PRs
    if: >-
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review_comment' && 
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request != null &&
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/review'))

    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
      statuses: 'write'

  # Permisos explicados:
  # - contents:read -> leer cÃ³digo para anÃ¡lisis
  # - id-token:write -> Ãºtil si se intercambian credenciales o tokens (OIDC)
  # - issues/pull-requests:write -> para comentar en PRs y crear issues si hace falta
  # - statuses:write -> permitir reportar checks/status al PR

    steps:
      - name: Checkout del cÃ³digo
        # Paso esencial: obtener el cÃ³digo del PR para poder extraer diffs y analizar.
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obtener diff del PR
        # Paso: construir un resumen limitado (hasta 10 archivos) con fragmentos del patch.
        # Esto se pasa luego al prompt para que Gemini revise los cambios mÃ¡s relevantes.
        id: get-diff
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number ||
                           (context.payload.issue?.pull_request ? context.payload.issue.number : null);
            
            if (prNumber) {
              try {
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                let diffContent = "**ARCHIVOS MODIFICADOS:**\n\n";
                
                for (const file of files.slice(0, 10)) { // Limitar a 10 archivos
                  diffContent += `### ğŸ“„ ${file.filename}\n`;
                  diffContent += `**Estado**: ${file.status}\n`;
                  diffContent += `**Cambios**: +${file.additions} -${file.deletions}\n\n`;
                  
                  if (file.patch) {
                    diffContent += "```diff\n";
                    diffContent += file.patch.substring(0, 2000); // Limitar tamaÃ±o
                    diffContent += "\n```\n\n";
                  }
                }
                
                return diffContent;
              } catch (error) {
                return "âŒ Error obteniendo diff del PR: " + error.message;
              }
            }
            return "âŒ No se pudo determinar el nÃºmero del PR";

      - name: Ejecutar Gemini CLI para RevisiÃ³n
        # Paso: enviar el diff resumido a Gemini para obtener comentarios estructurados
        id: gemini-review
        uses: google-github-actions/run-gemini-cli@v0.1.10
        with:
          prompt: |
            Eres un revisor de cÃ³digo experto y experimentado.

            **PULL REQUEST A REVISAR:**
            TÃ­tulo: ${{ github.event.pull_request.title || 'PR desde comentario' }}
            DescripciÃ³n: ${{ github.event.pull_request.body || 'Ver comentarios para contexto' }}
            
            **CÃ“DIGO DEL PR:**
            ${{ steps.get-diff.outputs.result }}

            Tu tarea es realizar una revisiÃ³n exhaustiva del Pull Request, enfocÃ¡ndote en:

            ğŸ”’ **Seguridad**: Vulnerabilidades, validaciÃ³n de entrada, autenticaciÃ³n
            âš¡ **Rendimiento**: Algoritmos eficientes, consultas optimizadas, uso de memoria
            ğŸ›¡ï¸ **Confiabilidad**: Manejo de errores, casos edge, testing
            ğŸ§¹ **Mantenibilidad**: CÃ³digo limpio, documentaciÃ³n, convenciones
            âœ… **Funcionalidad**: LÃ³gica correcta, cumplimiento de requisitos

            Proporciona feedback especÃ­fico usando estos emojis de prioridad:
            ğŸ”´ **CrÃ­tico**: Debe corregirse antes del merge
            ğŸŸ  **Alto**: DeberÃ­a corregirse
            ğŸŸ¡ **Medio**: Mejoras recomendadas
            ğŸŸ¢ **Bajo**: Sugerencias opcionales

            **Formato de respuesta**:

            ## ğŸ” RevisiÃ³n de CÃ³digo

            ### âœ… Aspectos Positivos
            - [Destacar buenas prÃ¡cticas encontradas]

            ### ğŸ” AnÃ¡lisis por CategorÃ­a

            #### ğŸ”’ Seguridad
            [EvaluaciÃ³n de seguridad]

            #### âš¡ Rendimiento  
            [EvaluaciÃ³n de rendimiento]

            #### ğŸ›¡ï¸ Confiabilidad
            [EvaluaciÃ³n de confiabilidad]

            #### ğŸ§¹ Mantenibilidad
            [EvaluaciÃ³n de mantenibilidad]

            ### ğŸ“‹ Recomendaciones

            #### ğŸ”´ CrÃ­ticas
            - [Issues que deben corregirse]

            #### ğŸŸ  Importantes
            - [Mejoras recomendadas]

            #### ğŸŸ¡ Sugerencias
            - [Mejoras opcionales]

            ### ğŸ¯ Veredicto
            - [ ] âœ… Aprobado - Listo para merge
            - [ ] ğŸ”„ Necesita cambios menores
            - [ ] â›” Requiere cambios importantes

            Responde en espaÃ±ol, sÃ© constructivo y proporciona ejemplos de cÃ³digo cuando sea Ãºtil.

          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Comentar revisiÃ³n en el PR
        # Paso: publicar la revisiÃ³n generada por Gemini como comentario en el PR.
        if: success()
        uses: actions/github-script@v7
        env:
          GEMINI_RESPONSE: ${{ steps.gemini-review.outputs.summary }}
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number ||
                           (context.payload.issue?.pull_request ? context.payload.issue.number : null);

            if (prNumber) {
              const geminiResponse = process.env.GEMINI_RESPONSE || 'No se pudo obtener la respuesta de Gemini.';
              
              // Comentar la revisiÃ³n
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ğŸ¤– **RevisiÃ³n AutomÃ¡tica por Gemini CLI**\n\n${geminiResponse}`
              });
              
              console.log(`RevisiÃ³n comentada en PR #${prNumber}`);
            }

      - name: Comentar si hay error
        # Paso: en caso de fallo, comentar con enlace a logs para facilitar debugging.
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.inputs?.pr_number ||
                           (context.payload.issue?.pull_request ? context.payload.issue.number : null);
                           
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âŒ Error al revisar el PR. [Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
              });
            }
