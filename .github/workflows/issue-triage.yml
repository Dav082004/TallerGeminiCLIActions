name: Gemini CLI - Clasificaci√≥n de Issues

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "N√∫mero del issue a clasificar"
        required: false
        type: string

jobs:
  triage:
    name: Clasificar Issue con Gemini
    runs-on: ubuntu-latest

    # Solo ejecutar en issues nuevos o cuando se solicite espec√≠ficamente
    if: >-
      github.event_name == 'issues' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/clasificar'))

    permissions:
      contents: read
      issues: write

    steps:
      - name: Ejecutar Gemini CLI para Clasificaci√≥n
        uses: google-github-actions/run-gemini-cli@v0.1.10
        with:
          prompt: |
            Eres un experto en gesti√≥n de proyectos y clasificaci√≥n de issues de software.

            Tu tarea es analizar el siguiente issue y:

            1. **Categorizar** el tipo de issue:
               - `bug` - Errores o fallos
               - `feature` - Nuevas funcionalidades
               - `enhancement` - Mejoras a funcionalidad existente
               - `documentation` - Relacionado con documentaci√≥n
               - `question` - Preguntas o consultas
               - `maintenance` - Tareas de mantenimiento
               - `security` - Problemas de seguridad

            2. **Determinar prioridad**:
               - `priority-critical` - Cr√≠tico, bloquea funcionalidad principal
               - `priority-high` - Alto, impacta usuarios importantes
               - `priority-medium` - Medio, mejora experiencia
               - `priority-low` - Bajo, mejora menor

            3. **Evaluar complejidad**:
               - `complexity-simple` - Soluci√≥n directa, pocas horas
               - `complexity-medium` - Requiere an√°lisis, d√≠as
               - `complexity-complex` - Cambios arquitect√≥nicos, semanas

            4. **Identificar √°rea**:
               - `area-frontend` - Interfaz de usuario
               - `area-backend` - L√≥gica del servidor
               - `area-database` - Base de datos
               - `area-api` - APIs y servicios
               - `area-devops` - Infraestructura y despliegue
               - `area-testing` - Pruebas y QA

            **Formato de respuesta**:

            ## üè∑Ô∏è Clasificaci√≥n Autom√°tica

            **Tipo**: [tipo]
            **Prioridad**: [prioridad]  
            **Complejidad**: [complejidad]
            **√Årea**: [√°rea]

            ## üìã An√°lisis

            [Breve explicaci√≥n del issue y raz√≥n de la clasificaci√≥n]

            ## üéØ Recomendaciones

            - [Sugerencia 1]
            - [Sugerencia 2]

            Responde siempre en espa√±ol y s√© espec√≠fico en tu an√°lisis.

          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Comentar si hay error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || 
                              context.payload.inputs?.issue_number;
                              
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ùå Error al clasificar el issue. [Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
              });
            }
