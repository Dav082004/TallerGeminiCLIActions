name: Clasificaci贸n de Issues con Gemini CLI

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  triage:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'issues') ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@gemini-cli') && 
       contains(github.event.comment.body, '/clasificar'))

    steps:
      - name: Descargar repositorio
        uses: actions/checkout@v4

      - name: Obtener contexto del issue
        id: context
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          fi

      - name: Ejecutar API de Gemini
        id: gemini
        run: |
          PROMPT="Eres un experto gerente de proyectos y clasificador de issues para el proyecto TaskFlow Manager.

          CONTEXTO: Esta es una aplicaci贸n web de gesti贸n de tareas construida con Node.js y JavaScript vanilla.

          TAREA: Analiza el siguiente issue de GitHub y proporciona recomendaciones de clasificaci贸n.

          T铆tulo del Issue: ${{ github.event.issue.title }}
          Contenido del Issue: ${{ github.event.issue.body }}
          Autor del Issue: ${{ github.event.issue.user.login }}

          CRITERIOS DE CLASIFICACIN:
          1. Clasificaci贸n: Determina si es un bug, solicitud de funci贸n, pregunta o issue de documentaci贸n
          2. Prioridad: Asigna prioridad (baja, media, alta, cr铆tica)
          3. Etiquetas: Sugiere etiquetas apropiadas
          4. Equipo: Sugiere equipo (frontend, backend, documentaci贸n)
          5. Esfuerzo: Proporciona estimaci贸n aproximada (1-5 story points)

          FORMATO DE RESPUESTA:
          Clasificaci贸n: [bug/mejora/pregunta/documentaci贸n]
          Prioridad: [baja/media/alta/cr铆tica]
          Esfuerzo Estimado: [1-5 story points]
          Equipo: [frontend/backend/documentaci贸n/cualquiera]
          Etiquetas Sugeridas: etiqueta1, etiqueta2, etiqueta3
          An谩lisis: Breve explicaci贸n del issue y razonamiento
          Pr贸ximos Pasos: 1. Paso uno 2. Paso dos"

          RESPONSE=$(curl -s -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"$PROMPT\"
                }]
              }]
            }" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent")

          RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: No se pudo procesar la clasificaci贸n"')
          
          echo "$RESULT" > resultado_clasificacion.txt
          echo "response_file=resultado_clasificacion.txt" >> $GITHUB_OUTPUT

      - name: Publicar comentario de clasificaci贸n
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultadoClasificacion = fs.readFileSync('resultado_clasificacion.txt', 'utf8');
            
            const comentario = '##  An谩lisis de Clasificaci贸n Gemini CLI\n\n' + 
                                resultadoClasificacion + 
                                '\n\n---\n *Esta clasificaci贸n fue realizada autom谩ticamente por Gemini CLI*\n *Para re-clasificar manualmente, comenta: `@gemini-cli /clasificar`*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.context.outputs.issue_number }},
              body: comentario
            });
