name:  Asistente Gemini CLI

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  assistant:
    runs-on: ubuntu-latest
    if: >
      contains(github.event.comment.body, '@gemini-cli') &&
      !contains(github.event.comment.body, '/clasificar') &&
      !contains(github.event.comment.body, '/revisar')

    steps:
      - name: Descargar repositorio
        uses: actions/checkout@v4

      - name: Extraer solicitud del usuario
        id: extract_request
        run: |
          # Extraer la parte despu茅s de @gemini-cli
          COMMENT_BODY="${{ github.event.comment.body }}"
          USER_REQUEST=$(echo "$COMMENT_BODY" | sed -n 's/.*@gemini-cli[[:space:]]*\(.*\)/\1/p' | head -1)

          # Guardar en salida de GitHub
          echo "user_request=$USER_REQUEST" >> $GITHUB_OUTPUT
          echo "Solicitud del usuario extra铆da: $USER_REQUEST"

      - name: Obtener contexto relevante
        id: context
        run: |
          # Obtener contexto actual del issue/PR
          if [ "${{ github.event.issue.pull_request }}" != "" ]; then
            CONTEXT_TYPE="pull_request"
            ITEM_NUMBER="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
            BODY="${{ github.event.issue.body }}"
          else
            CONTEXT_TYPE="issue"
            ITEM_NUMBER="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
            BODY="${{ github.event.issue.body }}"
          fi

          # Guardar contexto
          echo "context_type=$CONTEXT_TYPE" >> $GITHUB_OUTPUT
          echo "item_number=$ITEM_NUMBER" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

          # Obtener archivos relevantes del repositorio
          find . -name "*.js" -o -name "*.json" -o -name "*.md" | head -20 > relevant_files.txt
          echo "Archivos relevantes encontrados:"
          cat relevant_files.txt

      - name:  Ejecutar Asistente Gemini
        id: gemini_assistant
        run: |
          PROMPT="Eres el Asistente Gemini CLI para el proyecto TaskFlow Manager, un experto en desarrollo web con amplio conocimiento en JavaScript, Node.js y mejores pr谩cticas de desarrollo.

          CONTEXTO DEL PROYECTO:
          - Nombre: TaskFlow Manager
          - Tipo: Aplicaci贸n web de gesti贸n de tareas
          - Stack Tecnol贸gico:
            * Frontend: HTML5, CSS3, JavaScript vanilla
            * Backend: Node.js con Express
            * Base de datos: localStorage (frontend) + JSON API
            * Testing: Jest
            * Deployment: GitHub Pages + Heroku

          INFORMACIN DEL COMENTARIO:
          - Autor: ${{ github.event.comment.user.login }}
          - Tipo: ${{ steps.context.outputs.context_type }}
          - N煤mero: #${{ steps.context.outputs.item_number }}
          - T铆tulo: ${{ steps.context.outputs.title }}
          
          PREGUNTA/SOLICITUD:
          ${{ steps.extract_request.outputs.user_request }}

          CONTEXTO ADICIONAL:
          ${{ steps.context.outputs.body }}

          CAPACIDADES COMO ASISTENTE:
          1. Revisi贸n de C贸digo: Analizar c贸digo JavaScript/Node.js y sugerir mejoras
          2. Resoluci贸n de Problemas: Ayudar con debugging y troubleshooting
          3. Arquitectura: Recomendar patrones de dise帽o y estructuras de c贸digo
          4. Optimizaci贸n: Sugerir mejoras de rendimiento y mejores pr谩cticas
          5. Testing: Ayudar con estrategias de testing y casos de prueba
          6. Seguridad: Identificar vulnerabilidades y recomendar soluciones
          7. Documentaci贸n: Asistir con documentaci贸n t茅cnica y comentarios de c贸digo

          INSTRUCCIONES DE RESPUESTA:
          - S茅 espec铆fico y contextual al proyecto TaskFlow Manager
          - Proporciona ejemplos de c贸digo cuando sea relevante
          - Incluye enlaces a documentaci贸n relevante cuando sea 煤til
          - Mant茅n un tono profesional pero amigable
          - Si no tienes suficiente informaci贸n, pregunta por m谩s detalles espec铆ficos
          - Prioriza soluciones pr谩cticas y implementables

          FORMATO DE RESPUESTA:
          ##  Asistente Gemini CLI

          [Tu respuesta detallada aqu铆]

          ###  Recursos Adicionales
          - [Enlaces o referencias 煤tiles si aplica]

          ###  Pr贸ximos Pasos
          - [Pasos concretos que el usuario puede seguir]

          ---
           Necesitas m谩s ayuda? Menciona @gemini-cli con tu pregunta espec铆fica"

          RESPONSE=$(curl -s -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"$PROMPT\"
                }]
              }]
            }" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent")

          RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: No se pudo procesar la solicitud del asistente"')
          
          echo "$RESULT" > respuesta_asistente.txt

      - name:  Publicar respuesta del asistente
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const respuestaAsistente = fs.readFileSync('respuesta_asistente.txt', 'utf8');
            
            const comentario = respuestaAsistente + 
                              '\n\n---\n *Asistencia proporcionada por Gemini CLI*\n *Para m谩s ayuda, menciona @gemini-cli con tu pregunta espec铆fica*';

            const itemNumber = ${{ steps.context.outputs.item_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: itemNumber,
              body: comentario
            });
